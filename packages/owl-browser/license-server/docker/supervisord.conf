[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=5
loglevel=info
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ==============================================================================
# PostgreSQL 17
# ==============================================================================
[program:postgresql]
command=/usr/lib/postgresql/17/bin/postgres -D /var/lib/postgresql/17/main
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/app/logs/postgresql.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/postgresql_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
# PostgreSQL needs to start first
startsecs=5

# ==============================================================================
# Admin Server (Port 3035)
# Includes Customer Portal at /portal
# ==============================================================================
[program:admin-server]
command=/app/venv/bin/python /app/admin_server.py
directory=/app
user=root
autostart=true
autorestart=true
priority=20
startsecs=10
# Wait for PostgreSQL to be ready
startretries=5
stdout_logfile=/app/logs/admin_server.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/admin_server_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
environment=
    PATH="/app/venv/bin:%(ENV_PATH)s",
    VIRTUAL_ENV="/app/venv",
    PYTHONUNBUFFERED="1"

# ==============================================================================
# Subscription/License API Server (Port 3034)
# ==============================================================================
[program:subscription-server]
command=/app/venv/bin/python /app/subscription_server.py
directory=/app
user=root
autostart=true
autorestart=true
priority=20
startsecs=10
# Wait for PostgreSQL to be ready
startretries=5
stdout_logfile=/app/logs/subscription_server.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/subscription_server_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
environment=
    PATH="/app/venv/bin:%(ENV_PATH)s",
    VIRTUAL_ENV="/app/venv",
    PYTHONUNBUFFERED="1"

# ==============================================================================
# Process Group
# ==============================================================================
[group:owl-license-server]
programs=postgresql,admin-server,subscription-server
priority=999
