╔══════════════════════════════════════════════════════════════════════════════╗
║                    STRATEGIC PLANNER LLM FALLBACK CHAIN                      ║
║                           3-Tier Cost Optimization                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                            USER REQUEST                                     │
│  "Search Google for AI automation tools and extract the top 10 results"    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STRATEGIC PLANNER                                   │
│  1. Check if planning needed (should_plan)                                 │
│  2. Call _plan_with_fallback()                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       LLM FALLBACK CHAIN                                    │
│  Decision: Which tier to start with?                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
        ┌──────────────────┐  ┌──────────────┐  ┌──────────────┐
        │ Minor Re-plan?   │  │ Primary LLM  │  │ 3+ Llama     │
        │ Skip to Llama    │  │ (from config)│  │ Failures?    │
        └──────────────────┘  └──────────────┘  │ Escalate     │
                                                 └──────────────┘
                                      │
                                      ▼
╔══════════════════════════════════════════════════════════════════════════════╗
║                              TIER 1: KIMI K2                                 ║
║  Quality: ★★★★★ (Best)          Cost: $0.0008/call                          ║
║  Timeout: 5 seconds             Retries: 3                                  ║
╚══════════════════════════════════════════════════════════════════════════════╝
                                      │
                    ┌─────────────────┴─────────────────┐
                    │                                   │
                    ▼                                   ▼
          ┌─────────────────┐                  ┌─────────────┐
          │   SUCCESS       │                  │   TIMEOUT   │
          │   (2-5 sec)     │                  │   or ERROR  │
          └─────────────────┘                  └─────────────┘
                    │                                   │
                    │                                   ▼
                    │                   ╔══════════════════════════════════════════╗
                    │                   ║        TIER 2: LLAMA 3.1 8B              ║
                    │                   ║  Quality: ★★★★☆ (Good)                   ║
                    │                   ║  Cost: FREE                              ║
                    │                   ║  Timeout: 8 seconds                      ║
                    │                   ║  Retries: 3                              ║
                    │                   ╚══════════════════════════════════════════╝
                    │                                   │
                    │                   ┌───────────────┴───────────────┐
                    │                   │                               │
                    │                   ▼                               ▼
                    │         ┌─────────────────┐              ┌─────────────┐
                    │         │   SUCCESS       │              │   TIMEOUT   │
                    │         │   (2-8 sec)     │              │   or ERROR  │
                    │         └─────────────────┘              └─────────────┘
                    │                   │                               │
                    │                   │                               ▼
                    │                   │               ╔═══════════════════════════════════╗
                    │                   │               ║     TIER 3: OLLAMA 7B             ║
                    │                   │               ║  Quality: ★★★☆☆ (Basic)           ║
                    │                   │               ║  Cost: FREE                       ║
                    │                   │               ║  Timeout: 5 seconds               ║
                    │                   │               ║  Retries: 3                       ║
                    │                   │               ╚═══════════════════════════════════╝
                    │                   │                               │
                    │                   │               ┌───────────────┴───────────────┐
                    │                   │               │                               │
                    │                   │               ▼                               ▼
                    │                   │     ┌─────────────────┐              ┌─────────────┐
                    │                   │     │   SUCCESS       │              │ ALL TIERS   │
                    │                   │     │   (1-3 sec)     │              │   FAILED    │
                    │                   │     └─────────────────┘              └─────────────┘
                    │                   │               │                               │
                    └───────────────────┴───────────────┴───────────────────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────────┐
                              │         PARSE JSON RESPONSE             │
                              │  - Extract plan steps                   │
                              │  - Build TaskPlan object                │
                              │  - Track cost & tier used               │
                              └─────────────────────────────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────────┐
                              │         RETURN TO PLANNER               │
                              │  - ExecutionState created               │
                              │  - Plan saved to disk                   │
                              │  - Cost tracking updated                │
                              └─────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                            COST TRACKING                                     ║
╚══════════════════════════════════════════════════════════════════════════════╝

After each call:
┌─────────────────────────────────────────────────────────────────────────────┐
│ CostTracker.add_call(tier, tokens_in, tokens_out)                          │
│                                                                             │
│ Kimi K2 calls:      2    ($0.0016)                                         │
│ Llama 3.1 8B calls: 15   (FREE)                                            │
│ Ollama 7B calls:    3    (FREE)                                            │
│ Total calls:        20                                                     │
│                                                                             │
│ Estimated savings: $0.0144  (90% free)                                     │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                        SPECIAL FEATURES                                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. MINOR RE-PLAN OPTIMIZATION                                              │
│                                                                             │
│    When is_minor_replan=True:                                              │
│    ┌──────────────────────────────────────────────────────┐               │
│    │ Skip Kimi K2 (expensive) → Go straight to Llama     │               │
│    │ Saves ~$0.0008 per minor adjustment                 │               │
│    └──────────────────────────────────────────────────────┘               │
│                                                                             │
│    Example: "Add verification step to existing plan"                       │
│    Regular flow:  Kimi → Llama → Ollama                                   │
│    Optimized:     Llama → Ollama (skip Kimi!)                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. AUTO-ESCALATION                                                         │
│                                                                             │
│    Track consecutive_qwen_failures counter:                               │
│    ┌──────────────────────────────────────────────────────┐               │
│    │ If failures ≥ 3 → Next call escalates to Kimi      │               │
│    │ Reset counter on success                            │               │
│    └──────────────────────────────────────────────────────┘               │
│                                                                             │
│    Example: Complex task keeps failing with Qwen                           │
│    Failures: 1, 2, 3 → Escalate to Kimi for quality                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. TIMEOUT PROTECTION                                                      │
│                                                                             │
│    Each tier has timeout:                                                  │
│    ┌──────────────────────────────────────────────────────┐               │
│    │ Kimi:  5s  → Fast fail if server slow               │               │
│    │ Llama: 8s  → Slightly longer for local processing   │               │
│    │ Ollama: 5s → Fast local fallback                    │               │
│    └──────────────────────────────────────────────────────┘               │
│                                                                             │
│    If timeout → Immediately try next tier (no waiting)                     │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                        CONFIGURATION EXAMPLES                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ COST-OPTIMIZED (Default - Recommended)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ strategic_planner:                                                          │
│   primary_llm: llama              # Free Llama first                        │
│   use_llama_for_minor_replans: true                                        │
│   escalate_after_failures: 3                                               │
│                                                                             │
│ Result: ~90% free calls, excellent cost savings                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ QUALITY-FIRST                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ strategic_planner:                                                          │
│   primary_llm: kimi               # Best quality first                     │
│   escalate_after_failures: 1      # Don't wait long                        │
│                                                                             │
│ Result: Best quality, still has fallback for fault tolerance              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ LOCAL-ONLY (Zero API Costs)                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ strategic_planner:                                                          │
│   primary_llm: llama                                                       │
│                                                                             │
│ kimi:                                                                       │
│   enabled: false                  # Disable Kimi entirely                  │
│                                                                             │
│ Result: 100% free, no external API calls                                  │
└─────────────────────────────────────────────────────────────────────────────┘
